// Generated by CoffeeScript 1.4.0
(function() {
  var MAXCOUNTOBJECTS, MAXFOLLOWERSPERBUCKET, ObjectId, PageResult, PageResultInfinite, ProcessDefinitionMethods, errors, mongoose, _,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  _ = require('underscore-ext');

  PageResult = require('simple-paginator').PageResult;

  PageResultInfinite = require('simple-paginator').PageResultInfinite;

  errors = require('some-errors');

  mongoose = require("mongoose");

  ObjectId = mongoose.Types.ObjectId;

  MAXFOLLOWERSPERBUCKET = 100;

  MAXCOUNTOBJECTS = 50;

  /*
  Provides methods to interact with processDefinitions.
  */


  module.exports = ProcessDefinitionMethods = (function() {
    var CREATE_FIELDS, UPDATE_FIELDS;

    CREATE_FIELDS = ['_id', 'name', 'description', 'createdBy', 'bonitaProcessName'];

    UPDATE_FIELDS = ['name', 'description', 'createdBy', 'bonitaProcessName', 'sourceXlsx', 'sourceSize', 'sourceFilename', 'sourceType'];

    /*
      Initializes a new instance of the @see ProcessDefinitionMethods class.
      @param {Object} models A collection of models that can be used.
    */


    /*
      Initializes a new instance of the @see ProcessDefinitionMethods class.
      @param {Object} models A collection of models that can be used.
    */


    function ProcessDefinitionMethods(models) {
      this.models = models;
      this._getItem = __bind(this._getItem, this);

      this.put = __bind(this.put, this);

      this.patch = __bind(this.patch, this);

      this.undelete = __bind(this.undelete, this);

      this.destroy = __bind(this.destroy, this);

      this["delete"] = __bind(this["delete"], this);

      this.create = __bind(this.create, this);

      this.createOrPut = __bind(this.createOrPut, this);

      this.getForWrite = __bind(this.getForWrite, this);

      this.get = __bind(this.get, this);

      this.all = __bind(this.all, this);

    }

    ProcessDefinitionMethods.prototype.all = function(options, cb) {
      var _this = this;
      if (options == null) {
        options = {};
      }
      if (cb == null) {
        cb = function() {};
      }
      return this.models.ProcessDefinition.count({}, function(err, totalCount) {
        var query;
        if (err) {
          return cb(err);
        }
        query = _this.models.ProcessDefinition.find({});
        query.select(options.select || '_id name description bonitaProcessName');
        query.setOptions({
          skip: options.offset,
          limit: options.count
        });
        return query.exec(function(err, items) {
          if (err) {
            return cb(err);
          }
          return cb(null, new PageResult(items || [], totalCount, options.offset, options.count));
        });
      });
    };

    /*
      Retrieve a single processDefinition-item through it's id
    */


    ProcessDefinitionMethods.prototype.get = function(processDefinitionId, actor, ignoreSecurity, cb) {
      if (cb == null) {
        cb = function() {};
      }
      return this._getItem(processDefinitionId, actor, ignoreSecurity, false, cb);
    };

    /*
      Retrieve a single processDefinition-item through it's id and ensure that we have write access.
    */


    ProcessDefinitionMethods.prototype.getForWrite = function(processDefinitionId, actor, cb) {
      if (cb == null) {
        cb = function() {};
      }
      return this.models.ProcessDefinition.findOneValidateWrite(processDefinitionId, actor, cb);
    };

    ProcessDefinitionMethods.prototype.createOrPut = function(objs, actor, cb) {
      var _this = this;
      if (objs == null) {
        objs = {};
      }
      if (cb == null) {
        cb = function() {};
      }
      if (!objs._id) {
        return cb(new errors.UnprocessableEntity("_id"));
      }
      return this._getItem(objs._id, null, true, false, function(err, item) {
        if (err) {
          return cb(err);
        }
        if (item) {
          return _this.put(objs._id, objs, actor, true, cb);
        } else {
          return _this.create(objs, actor, cb);
        }
      });
    };

    /*
      Create a new processDefinition
    */


    ProcessDefinitionMethods.prototype.create = function(objs, actor, cb) {
      var data, model,
        _this = this;
      if (objs == null) {
        objs = {};
      }
      if (cb == null) {
        cb = function() {};
      }
      data = {};
      data.createdBy = actor;
      _.extendFiltered(data, CREATE_FIELDS, objs);
      if (!(data.createdBy && data.createdBy.actorId)) {
        return cb(new errors.UnprocessableEntity("createdBy"));
      }
      model = new this.models.ProcessDefinition(data);
      return model.save(function(err) {
        if (err) {
          return cb(err);
        }
        return cb(null, model, true);
      });
    };

    ProcessDefinitionMethods.prototype["delete"] = function(processDefinitionId, actor, ignoreSecurity, cb) {
      var _this = this;
      if (cb == null) {
        cb = function() {};
      }
      return this._getItem(processDefinitionId, actor, ignoreSecurity, true, function(err, item) {
        if (err) {
          return cb(err);
        }
        if (!item) {
          return cb(null);
        }
        if (item.isDeleted) {
          return cb(null);
        }
        item.isDeleted = true;
        item.deletedAt = new Date();
        return item.save(function(err) {
          if (err) {
            return cb(err);
          }
          return cb(null);
        });
      });
    };

    ProcessDefinitionMethods.prototype.destroy = function(processDefinitionId, actor, ignoreSecurity, cb) {
      var _this = this;
      if (cb == null) {
        cb = function() {};
      }
      return this._getItem(processDefinitionId, actor, ignoreSecurity, true, function(err, item) {
        if (err) {
          return cb(err);
        }
        if (!item) {
          return cb(null);
        }
        return item.remove(function(err) {
          if (err) {
            return cb(err);
          }
          return cb(null);
        });
      });
    };

    ProcessDefinitionMethods.prototype.undelete = function(processDefinitionId, actor, ignoreSecurity, cb) {
      var _this = this;
      if (cb == null) {
        cb = function() {};
      }
      return this._getItem(processDefinitionId, actor, ignoreSecurity, true, function(err, item) {
        if (err) {
          return cb(err);
        }
        if (!item) {
          return cb(new errors.NotFound("/processDefinitions/" + processDefinitionId));
        }
        if (!item.isDeleted) {
          return cb(null, item);
        }
        item.isDeleted = false;
        item.deletedAt = null;
        return item.save(function(err) {
          if (err) {
            return cb(err);
          }
          return cb(null, item);
        });
      });
    };

    ProcessDefinitionMethods.prototype.patch = function(processDefinitionId, obj, actor, ignoreSecurity, cb) {
      var _this = this;
      if (obj == null) {
        obj = {};
      }
      if (cb == null) {
        cb = function() {};
      }
      return this._getItem(processDefinitionId, actor, ignoreSecurity, true, function(err, item) {
        if (err) {
          return cb(err);
        }
        if (!item) {
          return cb(new errors.NotFound("/processDefinitions/" + processDefinitionId));
        }
        _.extendFiltered(item, UPDATE_FIELDS, obj);
        return item.save(function(err) {
          if (err) {
            return cb(err);
          }
          return cb(null, item);
        });
      });
    };

    ProcessDefinitionMethods.prototype.put = function(processDefinitionId, obj, actor, ignoreSecurity, cb) {
      var _this = this;
      if (obj == null) {
        obj = {};
      }
      if (cb == null) {
        cb = function() {};
      }
      return this._getItem(processDefinitionId, actor, ignoreSecurity, true, function(err, item) {
        var field, _i, _len;
        if (err) {
          return cb(err);
        }
        if (!item) {
          return cb(new errors.NotFound("/processDefinitions/" + processDefinitionId));
        }
        for (_i = 0, _len = UPDATE_FIELDS.length; _i < _len; _i++) {
          field = UPDATE_FIELDS[_i];
          item[field] = null;
        }
        _.extendFiltered(item, UPDATE_FIELDS, obj);
        return item.save(function(err) {
          if (err) {
            return cb(err);
          }
          return cb(null, item);
        });
      });
    };

    ProcessDefinitionMethods.prototype._getItem = function(processDefinitionId, actor, ignoreSecurity, forWrite, cb) {
      return this.models.ProcessDefinition.findOne({
        _id: processDefinitionId
      }, cb);
    };

    return ProcessDefinitionMethods;

  })();

}).call(this);
