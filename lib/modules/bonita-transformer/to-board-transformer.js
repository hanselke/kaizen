// Generated by CoffeeScript 1.4.0
(function() {
  var _;

  _ = require('underscore-ext');

  /*
  Transforms raw data to the one that is sent to the client.
  */


  module.exports = function(processDefinition, processInstances) {
    var activity, activityDefinition, activityDefinitionUUID, adMap, afterTime, beforeTime, card, instance, instanceStateUpdates, lane, lastUpdate, myLane, newLane, result, startedDate, totalTime, _i, _j, _k, _l, _len, _len1, _len2, _len3, _len4, _m, _ref, _ref1, _ref2, _ref3, _ref4, _ref5, _ref6, _ref7, _ref8, _ref9;
    result = {
      lanes: []
    };
    adMap = {};
    _ref1 = (_ref = processDefinition.activities) != null ? _ref.ActivityDefinition : void 0;
    for (_i = 0, _len = _ref1.length; _i < _len; _i++) {
      activityDefinition = _ref1[_i];
      if (activityDefinition.description && _.isString(activityDefinition.description) && activityDefinition.description.length > 0 && activityDefinition.uuid && activityDefinition.uuid.value) {
        newLane = {
          label: activityDefinition.description || "",
          name: activityDefinition.name || "",
          id: activityDefinition.uuid.value,
          totalTime: 0,
          totalCost: 0,
          beforeTime: 0,
          afterTime: 0,
          cards: []
        };
        result.lanes.push(newLane);
        adMap[activityDefinition.uuid.value] = newLane;
      }
    }
    /*
      result.lanes.push
        label : "Done"
        name : 'done'
        cards: []
    */

    _ref2 = processInstances != null ? processInstances.ProcessInstance : void 0;
    for (_j = 0, _len1 = _ref2.length; _j < _len1; _j++) {
      instance = _ref2[_j];
      console.log("ONE INSTANCE " + instance.instanceUUID.value);
      _ref4 = (_ref3 = instance.activities) != null ? _ref3.ActivityInstance : void 0;
      for (_k = 0, _len2 = _ref4.length; _k < _len2; _k++) {
        activity = _ref4[_k];
        activityDefinitionUUID = (_ref5 = activity.activityDefinitionUUID) != null ? _ref5.value : void 0;
        if (true) {
          console.log("ACTIVITY DEFINITION: " + activityDefinitionUUID);
          myLane = adMap[activityDefinitionUUID];
          startedDate = activity.startedDate || 0;
          lastUpdate = activity.lastUpdate || 0;
          totalTime = lastUpdate - startedDate;
          beforeTime = 0;
          afterTime = 0;
          if (totalTime > 10000000000) {
            totalTime = 0;
            beforeTime = 0;
            afterTime = 0;
          }
          instanceStateUpdates = activity.instanceStateUpdates;
          if (_.isObject(instanceStateUpdates) && _.keys(instanceStateUpdates).length > 0) {
            instanceStateUpdates = [instanceStateUpdates.InstanceStateUpdate];
          }
          if (instanceStateUpdates && _.isArray(instanceStateUpdates && instanceStateUpdates.length > 0)) {
            beforeTime = _.first(instanceStateUpdates).date - activity.startedDate;
            afterTime = activity.lastUpdate - _.first(instanceStateUpdates).date;
          }
          if (myLane) {
            myLane.cards.push({
              id: (_ref6 = activity.uuid) != null ? _ref6.value : void 0,
              desc: activity.label,
              ready: ((_ref7 = activity.state) != null ? _ref7.toUpperCase() : void 0) === "READY",
              state: activity.state,
              processInstance: instance.instanceUUID.value,
              totalTime: totalTime,
              totalCost: 0,
              beforeTime: beforeTime,
              afterTime: afterTime
            });
          }
        }
      }
      _ref8 = result.lanes;
      for (_l = 0, _len3 = _ref8.length; _l < _len3; _l++) {
        lane = _ref8[_l];
        _ref9 = lane.cards;
        for (_m = 0, _len4 = _ref9.length; _m < _len4; _m++) {
          card = _ref9[_m];
          lane.totalTime = lane.totalTime + card.totalTime;
          lane.totalCost = lane.totalCost + card.totalCost;
          lane.beforeTime = lane.beforeTime + card.beforeTime;
          lane.afterTime = lane.afterTime + card.totalTime;
        }
      }
    }
    return result;
  };

}).call(this);
