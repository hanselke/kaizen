// Generated by CoffeeScript 1.4.0
(function() {
  var _;

  _ = require('underscore-ext');

  /*
  Transforms raw data to the one that is sent to the client.
  */


  module.exports = function(processes, processInstances) {
    var activity, activityDefinition, activityId, adMap, instance, myLane, newLane, processDefinition, result, _i, _j, _k, _l, _len, _len1, _len2, _len3, _ref, _ref1, _ref2, _ref3, _ref4, _ref5, _ref6, _ref7, _ref8;
    result = {
      lanes: []
    };
    adMap = {};
    _ref = processes != null ? processes.ProcessDefinition : void 0;
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      processDefinition = _ref[_i];
      _ref2 = (_ref1 = processDefinition.activities) != null ? _ref1.ActivityDefinition : void 0;
      for (_j = 0, _len1 = _ref2.length; _j < _len1; _j++) {
        activityDefinition = _ref2[_j];
        if (activityDefinition.description && _.isString(activityDefinition.description) && activityDefinition.description.length > 0 && activityDefinition.uuid && activityDefinition.uuid.value) {
          newLane = {
            label: activityDefinition.description || "",
            name: activityDefinition.name || "",
            id: activityDefinition.uuid.value,
            cards: []
          };
          result.lanes.push(newLane);
          adMap[activityDefinition.uuid.value] = newLane;
        }
      }
    }
    /*
      result.lanes.push
        label : "Done"
        name : 'done'
        cards: []
    */

    _ref3 = processInstances != null ? processInstances.ProcessInstance : void 0;
    for (_k = 0, _len2 = _ref3.length; _k < _len2; _k++) {
      instance = _ref3[_k];
      console.log("ONE INSTANCE " + instance.instanceUUID.value);
      console.log(JSON.stringify(instance));
      _ref5 = (_ref4 = instance.activities) != null ? _ref4.ActivityInstance : void 0;
      for (_l = 0, _len3 = _ref5.length; _l < _len3; _l++) {
        activity = _ref5[_l];
        activityId = (_ref6 = activity.activityDefinitionUUID) != null ? _ref6.value : void 0;
        if (activity.state === "READY") {
          console.log("ACTIVITY: " + activityId);
          myLane = adMap[activityId];
          if (myLane) {
            myLane.cards.push({
              id: (_ref7 = activity.uuid) != null ? _ref7.value : void 0,
              desc: activity.label,
              ready: ((_ref8 = activity.state) != null ? _ref8.toUpperCase() : void 0) === "READY",
              state: activity.state,
              processInstance: instance.instanceUUID.value
            });
          }
        }
      }
    }
    return result;
  };

}).call(this);
