// Generated by CoffeeScript 1.4.0
(function() {
  var stateMachinePackage, _;

  _ = require('underscore');

  stateMachinePackage = require('openb-app-state-machine');

  module.exports = function(roles, dbStore, cb) {
    var statesResult;
    statesResult = [];
    return dbStore.processDefinitions.all({
      count: 1000,
      select: 'stateMachine'
    }, function(err, processDefinitionsResult) {
      var processDefinition, sm, smData, _i, _len, _ref;
      if (err) {
        return next(err);
      }
      _ref = processDefinitionsResult.items;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        processDefinition = _ref[_i];
        smData = null;
        try {
          smData = JSON.parse(processDefinition.stateMachine);
        } catch (e) {
          console.log("Could not parse statemachine for " + processDefinition.name);
          console.log(processDefinition.stateMachine);
        }
        if (smData) {
          sm = stateMachinePackage.stateMachine();
          sm.loadFromObject(smData);
          statesResult = _.union(statesResult, sm.getStatesForRoles(roles));
        }
      }
      console.log("States: " + statesResult);
      return cb(null, statesResult);
    });
  };

}).call(this);
